<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch2gether - Simple Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #111827 0%, #3730a3 50%, #581c87 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .video-container {
            background: black;
            border-radius: 0.5rem;
            overflow: hidden;
            aspect-ratio: 16/9;
        }

        .chat-container {
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .chat-input {
            display: flex;
            gap: 0.5rem;
        }

        input, button {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 1rem;
        }

        input {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            flex: 1;
        }

        button {
            background: #7c3aed;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background: #6d28d9;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .login-card {
            max-width: 400px;
            width: 100%;
        }

        .video-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
        }

        video, iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .viewers {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .viewer-badge {
            background: rgba(124, 58, 237, 0.5);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
        }

        .grid {
            display: grid;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        .flex {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .message {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid #f59e0b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Simple Firebase-like service using localStorage and polling
        class SimpleSync {
            constructor() {
                this.rooms = new Map();
                this.pollingIntervals = new Map();
            }

            // Create or get a room
            room(roomId) {
                if (!this.rooms.has(roomId)) {
                    this.rooms.set(roomId, {
                        data: this.loadFromStorage(roomId),
                        listeners: new Set()
                    });
                }
                return this.rooms.get(roomId);
            }

            // Save data to a room
            set(roomId, data) {
                const room = this.room(roomId);
                room.data = { ...room.data, ...data, lastUpdated: Date.now() };
                this.saveToStorage(roomId, room.data);
                
                // Notify listeners
                room.listeners.forEach(callback => callback(room.data));
                return true;
            }

            // Get data from a room
            get(roomId) {
                const room = this.room(roomId);
                return room.data;
            }

            // Listen for changes
            onSnapshot(roomId, callback) {
                const room = this.room(roomId);
                room.listeners.add(callback);
                
                // Start polling if not already started
                if (!this.pollingIntervals.has(roomId)) {
                    const interval = setInterval(() => {
                        const stored = this.loadFromStorage(roomId);
                        if (stored.lastUpdated > (room.data.lastUpdated || 0)) {
                            room.data = stored;
                            room.listeners.forEach(cb => cb(stored));
                        }
                    }, 1000);
                    this.pollingIntervals.set(roomId, interval);
                }

                // Return unsubscribe function
                return () => {
                    room.listeners.delete(callback);
                    if (room.listeners.size === 0) {
                        clearInterval(this.pollingIntervals.get(roomId));
                        this.pollingIntervals.delete(roomId);
                    }
                };
            }

            loadFromStorage(roomId) {
                try {
                    return JSON.parse(localStorage.getItem(`room_${roomId}`)) || {};
                } catch {
                    return {};
                }
            }

            saveToStorage(roomId, data) {
                localStorage.setItem(`room_${roomId}`, JSON.stringify(data));
            }
        }

        // Initialize sync service
        const sync = new SimpleSync();

        // State management
        let state = {
            username: '',
            roomId: '',
            currentRoom: null,
            videoUrl: '',
            messages: [],
            messageInput: '',
            viewers: [],
            isInRoom: false,
            videoState: { playing: false, currentTime: 0 },
            unsubscribe: null
        };

        let videoElement = null;

        // Generate room ID
        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Get embed URL for videos
        function getEmbedUrl(url) {
            if (!url) return '';
            
            // YouTube
            const youtubeRegex = /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/;
            const youtubeMatch = url.match(youtubeRegex);
            if (youtubeMatch) {
                return `https://www.youtube.com/embed/${youtubeMatch[1]}`;
            }
            
            // Direct videos
            if (url.match(/\.(mp4|webm|ogg|mov|avi|mkv)$/i)) {
                return url;
            }
            
            return url;
        }

        function isDirectVideo(url) {
            return url && url.match(/\.(mp4|webm|ogg|mov|avi|mkv)$/i);
        }

        // Create room
        function createRoom() {
            if (!state.username.trim()) {
                alert('Please enter your username');
                return;
            }

            const roomId = generateRoomId();
            state.currentRoom = roomId;
            state.isInRoom = true;
            state.viewers = [state.username];
            state.messages = [{
                sender: 'System',
                text: `Room created! Share this ID: ${roomId}`,
                time: new Date().toLocaleTimeString()
            }];

            // Save initial room data
            sync.set(roomId, {
                videoUrl: '',
                messages: state.messages,
                viewers: state.viewers,
                videoState: state.videoState
            });

            // Listen for changes
            state.unsubscribe = sync.onSnapshot(roomId, (data) => {
                updateState(data);
            });

            render();
        }

        // Join room
        function joinRoom() {
            if (!state.username.trim() || !state.roomId.trim()) {
                alert('Please enter both username and room ID');
                return;
            }

            const roomId = state.roomId.toUpperCase();
            const roomData = sync.get(roomId);

            if (!roomData.messages) {
                alert('Room not found!');
                return;
            }

            state.currentRoom = roomId;
            state.isInRoom = true;

            // Add user to viewers
            const viewers = roomData.viewers || [];
            if (!viewers.includes(state.username)) {
                viewers.push(state.username);
            }

            // Add join message
            const messages = roomData.messages || [];
            messages.push({
                sender: 'System',
                text: `${state.username} joined the room`,
                time: new Date().toLocaleTimeString()
            });

            // Update room
            sync.set(roomId, {
                viewers: viewers,
                messages: messages,
                videoUrl: roomData.videoUrl || '',
                videoState: roomData.videoState || state.videoState
            });

            // Update local state
            state.viewers = viewers;
            state.messages = messages;
            state.videoUrl = roomData.videoUrl || '';

            // Listen for changes
            state.unsubscribe = sync.onSnapshot(roomId, (data) => {
                updateState(data);
            });

            render();
        }

        // Update state from sync
        function updateState(data) {
            let changed = false;

            if (data.videoUrl !== state.videoUrl) {
                state.videoUrl = data.videoUrl;
                changed = true;
            }

            if (data.messages && data.messages.length !== state.messages.length) {
                state.messages = data.messages;
                changed = true;
            }

            if (data.viewers && JSON.stringify(data.viewers) !== JSON.stringify(state.viewers)) {
                state.viewers = data.viewers;
                changed = true;
            }

            if (data.videoState) {
                syncVideo(data.videoState);
            }

            if (changed) {
                render();
            }
        }

        // Set video
        function setVideo() {
            if (!state.videoUrl.trim()) {
                alert('Please enter a video URL');
                return;
            }

            const messages = [...state.messages, {
                sender: 'System',
                text: `Video set by ${state.username}`,
                time: new Date().toLocaleTimeString()
            }];

            sync.set(state.currentRoom, {
                videoUrl: state.videoUrl,
                messages: messages,
                videoState: { playing: false, currentTime: 0 }
            });

            state.messages = messages;
            state.videoUrl = '';
            render();
        }

        // Send message
        function sendMessage() {
            if (!state.messageInput.trim()) return;

            const messages = [...state.messages, {
                sender: state.username,
                text: state.messageInput,
                time: new Date().toLocaleTimeString()
            }];

            sync.set(state.currentRoom, { messages: messages });
            state.messages = messages;
            state.messageInput = '';
            render();
        }

        // Video sync functions
        function setupVideoSync() {
            videoElement = document.getElementById('videoPlayer');
            if (!videoElement || videoElement.tagName !== 'VIDEO') return;

            videoElement.addEventListener('play', () => updateVideoState(true));
            videoElement.addEventListener('pause', () => updateVideoState(false));
            videoElement.addEventListener('seeked', () => updateVideoState(!videoElement.paused));
        }

        function updateVideoState(playing) {
            if (videoElement) {
                sync.set(state.currentRoom, {
                    videoState: {
                        playing: playing,
                        currentTime: videoElement.currentTime,
                        lastUpdated: Date.now()
                    }
                });
            }
        }

        function syncVideo(remoteState) {
            if (!videoElement || videoElement.tagName !== 'VIDEO') return;

            const timeDiff = Math.abs(remoteState.currentTime - videoElement.currentTime);
            if (timeDiff > 2) {
                videoElement.currentTime = remoteState.currentTime;
            }

            if (remoteState.playing && videoElement.paused) {
                videoElement.play();
            } else if (!remoteState.playing && !videoElement.paused) {
                videoElement.pause();
            }
        }

        function copyRoomId() {
            navigator.clipboard.writeText(state.currentRoom)
                .then(() => alert('Room ID copied!'))
                .catch(err => console.error('Copy failed:', err));
        }

        function leaveRoom() {
            if (state.unsubscribe) {
                state.unsubscribe();
            }

            // Remove user from viewers
            if (state.currentRoom) {
                const roomData = sync.get(state.currentRoom);
                const viewers = roomData.viewers || [];
                const index = viewers.indexOf(state.username);
                if (index > -1) {
                    viewers.splice(index, 1);
                }
                sync.set(state.currentRoom, { viewers: viewers });
            }

            state.isInRoom = false;
            state.currentRoom = null;
            state.videoUrl = '';
            state.messages = [];
            state.viewers = [];
            render();
        }

        // Render functions
        function renderLoginScreen() {
            return `
                <div class="login-screen">
                    <div class="card login-card">
                        <h1>Watch2gether</h1>
                        <p class="subtitle">Simple Sync Version</p>
                        
                        <div style="margin-bottom: 1rem;">
                            <label>Your Username</label>
                            <input 
                                type="text" 
                                id="username" 
                                value="${state.username}"
                                placeholder="Enter your name"
                            />
                        </div>
                        
                        <button onclick="createRoom()">
                            üë• Create New Room
                        </button>
                        
                        <div style="border-top: 1px solid rgba(255,255,255,0.2); margin: 1.5rem 0; padding-top: 1.5rem;">
                            <label>Join Existing Room</label>
                            <input 
                                type="text" 
                                id="roomId" 
                                value="${state.roomId}"
                                placeholder="Enter Room ID"
                                style="margin-bottom: 0.75rem;"
                            />
                            <button onclick="joinRoom()" style="background: #4f46e5;">
                                Join Room
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainScreen() {
            const embedUrl = getEmbedUrl(state.videoUrl);
            const isDirect = isDirectVideo(state.videoUrl);

            let videoElement = '';
            if (state.videoUrl) {
                if (isDirect) {
                    videoElement = `<video id="videoPlayer" controls src="${state.videoUrl}"></video>`;
                } else {
                    videoElement = `<iframe id="videoPlayer" src="${embedUrl}" allowfullscreen></iframe>`;
                }
            } else {
                videoElement = `
                    <div class="video-placeholder">
                        <div>
                            <p style="font-size: 3rem; margin-bottom: 1rem;">‚ñ∂Ô∏è</p>
                            <p>No video loaded</p>
                            <p>Add a YouTube URL or direct video link</p>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="container">
                    <div class="warning">
                        ‚ö†Ô∏è This works across devices using browser sync. For best results, use direct video URLs.
                    </div>
                    
                    <div class="header">
                        <div>
                            <h2>Watch2gether</h2>
                            <p>Room: ${state.currentRoom} 
                                <button class="btn-small" onclick="copyRoomId()">Copy ID</button>
                            </p>
                        </div>
                        <div class="flex">
                            <span>üë• ${state.viewers.length} viewers</span>
                            <button class="btn-small" style="background: #4f46e5;" onclick="leaveRoom()">Leave</button>
                        </div>
                    </div>
                    
                    <div class="grid">
                        <div>
                            <div class="card">
                                <div class="video-container">
                                    ${videoElement}
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3>Add Video URL</h3>
                                <div class="flex">
                                    <input 
                                        type="text" 
                                        id="videoUrl" 
                                        value="${state.videoUrl}"
                                        placeholder="YouTube URL or direct video link"
                                    />
                                    <button onclick="setVideo()">Load</button>
                                </div>
                                <div style="font-size: 0.75rem; color: #c4b5fd; margin-top: 0.5rem;">
                                    <div>Try: https://www.youtube.com/watch?v=dQw4w9WgXcQ</div>
                                    <div>Or: https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4</div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3>Viewers (${state.viewers.length})</h3>
                                <div class="viewers">
                                    ${state.viewers.map(viewer => `
                                        <span class="viewer-badge">${viewer}</span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="card chat-container">
                                <h3>Chat</h3>
                                <div class="chat-messages" id="chatMessages">
                                    ${state.messages.map(msg => `
                                        <div class="message">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                                <span style="font-weight: bold; color: ${msg.sender === 'System' ? '#fcd34d' : '#c4b5fd'}">
                                                    ${msg.sender}
                                                </span>
                                                <span style="color: rgba(255,255,255,0.5); font-size: 0.75rem;">${msg.time}</span>
                                            </div>
                                            <div>${msg.text}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="chat-input">
                                    <input 
                                        type="text" 
                                        id="messageInput" 
                                        value="${state.messageInput}"
                                        placeholder="Type a message..."
                                    />
                                    <button onclick="sendMessage()">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = state.isInRoom ? renderMainScreen() : renderLoginScreen();
            
            if (!state.isInRoom) {
                const usernameInput = document.getElementById('username');
                const roomIdInput = document.getElementById('roomId');
                
                if (usernameInput) {
                    usernameInput.addEventListener('input', (e) => state.username = e.target.value);
                    usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') createRoom(); });
                }
                if (roomIdInput) {
                    roomIdInput.addEventListener('input', (e) => state.roomId = e.target.value);
                    roomIdInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') joinRoom(); });
                }
            } else {
                const videoUrlInput = document.getElementById('videoUrl');
                const messageInput = document.getElementById('messageInput');
                
                if (videoUrlInput) {
                    videoUrlInput.addEventListener('input', (e) => state.videoUrl = e.target.value);
                    videoUrlInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') setVideo(); });
                }
                if (messageInput) {
                    messageInput.addEventListener('input', (e) => state.messageInput = e.target.value);
                    messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
                }
                
                setTimeout(setupVideoSync, 100);
                
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Initialize
        render();
        window.createRoom = createRoom;
        window.joinRoom = joinRoom;
        window.setVideo = setVideo;
        window.sendMessage = sendMessage;
        window.copyRoomId = copyRoomId;
        window.leaveRoom = leaveRoom;
    </script>
</body>
</html>
